# This workflow will do scan of dependencies to check for issues like vulnerabilities.

name: dependencycheck

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 12:00 AM Daily
  pull_request:
    branches: [main, master]

jobs:
  dependencycheck:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [20.x]

    timeout-minutes: 60 # Default 5 days for self hosted
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci

      # Dependency-Check
      - name: Dependency-Check
        run: npx owasp-dependency-check --scan . --failOnCVSS 1 --nvdApiKey ${{ secrets.NVD_KEY }} --disableYarnAudit --exclude node_modules/node-gyp/**/* --exclude dependency-check-bin/**/* --suppression https://github.com/MO-Movia/suppressions/raw/refs/heads/main/suppression.xml
      - name: Upload Report
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: dependency-check-reports
          path: dependency-check-reports
      # Dependency-Track
      - name: Dependency-Track
        run: npx @cyclonedx/cyclonedx-npm --package-lock-only --output-file SBOM.json
        
